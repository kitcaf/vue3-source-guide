# 3.3.5 实现 getCurrentInstance

截至到目前，我们只在**组件的render函数**绑定了**this**（_ctx）**指向当前的组件代理**，组件的setup函数是没有绑定this，那么问题来了：如果我想在 `setup` 里访问组件内部的属性（$el-改为了ref，$router-改为了useRouter），**应该怎么办？**

`getCurrentInstance` 是一个在 `setup` 中使用的全局 API，它返回当前正在执行 `setup` 的组件实例对象。
原理非常简单：**全局变量 + 赋值锁**

- 定义一个全局变量 `currentInstance`
- 在执行组件的 `setup` **之前**，把这个变量指向当前组件实例。
- 在执行组件的 `setup` **之后**，把这个变量重置为 `null`
- 那么在seup中调用 `getCurrentInstance()` 时，直接返回这个全局变量

## 基础实现

```typescript
//packages\runtime-core\src\component.ts
...
let currentInstance: ComponentInternalInstance | null = null

export function getCurrentInstance() {
    return currentInstance;
}

export function setCurrentInstance(instance: ComponentInternalInstance | null) {
    currentInstance = instance;
}
...
export function setupStatefulComponent(instance: ComponentInternalInstance) {
    const Component = instance.type;
    const { setup } = Component

    if (setup) {
        // 在调用 setup 之前，设置全局变量
        setCurrentInstance(instance)
        const setupResult = setup(instance.props, {
            emit: instance.emit
        })
        // 执行完毕后，重置全局变量
        setCurrentInstance(null)
        handleSetupResult(instance, setupResult)
    } else {
        finishComponentSetup(instance)
    }
}
...
```