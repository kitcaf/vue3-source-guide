# 3.2.6 实现初始化 element 主流程

**初始化 Element** 是指将类型为 **HTML 标签**（如 `div`, `span`）的 VNode 转换为宿主环境（浏览器）中真实的 **DOM 元素**，并挂载到页面上的过程。

**组件最终是由 HTML 标签组成的**。`mountComponent` 只是逻辑上的拆箱，`mountElement` 才是真正往页面上画东西的那一步

Vue 的渲染树是递归的。Component -> Component -> Element。到了 Element 这一层，就不再是 Vue 的逻辑了，而是浏览器的逻辑

主要四个步骤：

- **创建节点 (Create)**：调用原生 API **创建HTML标签**（如 `document.createElement`）
- **处理属性 (Props)**：遍历 VNode 的 props，把属性、事件添加到 DOM 上
- **处理子节点 (Children)**：如果是文本直接设置文本内容，如果是数组，**继续递归调用patch每一个子节点**

注意：这里需要大量使用 `createElement`, `insert` 等操作。为了保持 `runtime-core` 的纯净，通常不能直接写 `document.xxx`，而是要调用 `options` 里传进来的方法（这就解释了为什么前面要写 `createRenderer`）

第一步：定义 RendererOptions 接口

```tsx
// 渲染器配置项接口 (由 runtime-dom 实现并传入)
export interface RendererOptions {
    createElement(type: string): any;
    patchProp(el: any, key: string, prevValue: any, nextValue: any): void;
    insert(el: any, parent: any, anchor?: any): void;
}
```

第二步：实现 `mountElement`

```tsx
function mountElement(vnode: VNode, container: Element) {
    // 创建真实DOM
    const el = hostCreateElement(vnode.type as string)
    vnode.el = el as Element

    const { shapeFlag, children } = vnode
    // 处理子节点
    if (shapeFlag & ShapeFlags.TEXT_CHILDREN) {
        el.textContent = children as string
    }
    else if (shapeFlag & ShapeFlags.ARRAY_CHILDREN) {
        mountChildren(children as VNode[], el)
    }

    // 处理属性
    const { props } = vnode
    for (const key in props) {
        const val = props[key]
        hostPatchProp(el, key, null, val)
    }
    //插入到容器中
    hostInsert(el, container)
}

function mountChildren(children: VNode[], container: Element) {
    children.forEach(vnode => {
        patch(null, vnode, container)
    })
    }
```

第三步：完善 `patch` 分发逻辑

```tsx
function patch(n1: VNode | null, n2: VNode, container: HTMLElement) {
    const { shapeFlag } = n2
    //挂载阶段
    if (!n1) {
        // 处理组件vNode
        if (shapeFlag & ShapeFlags.STATEFUL_COMPONENT) {
            processComponent(n1, n2, container)
        }
        // 处理Element vNode
        if (shapeFlag & ShapeFlags.ELEMENT) {
            if (!n1) mountElement(n2, container) // 挂载
        }
    }
}
```