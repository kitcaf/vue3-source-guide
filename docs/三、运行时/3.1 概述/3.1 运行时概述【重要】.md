

# 运行时概述

在上一章中，我们已经实现了响应式数据 (Reactivity)，本章**运行时就是将响应式数据与 真实视图 (DOM) 的桥梁**

在前端框架的语境下，**运行时 (Runtime)** 指的是框架在浏览器（或 Node.js 等环境）中实际执行的代码模块，它负责**管理组件的生命周期**以及**将状态 (State) 映射为真实的 UI 界面**

vue.js**框架的运行**时一句话描述：**从虚拟 DOM 到真实 DOM，处理组件渲染与更新**

## Virtual DOM vs. Real DOM

### (1) Real DOM (真实 DOM)

这是浏览器引擎提供的原生接口。浏览器内核（C++）里的对象在 JavaScript 中的映射

比如常见的 div标签：

```tsx
const div = document.createElement('div'); // 这是一个真实的 DOM 节点对象
div.className = 'title';
div.innerText = 'hello'; // 它是“沉重”的，挂载了大量的原生属性和方法
```

真实DOM树很熟悉了，我就不提了

### (2) Virtual DOM (虚拟 DOM / VNode)

这是vue.js框架层定义的 JavaScript 对象。一个轻量级的纯 JavaScript 对象 (POJO)，用于描述真实 DOM 应该长什么样。

如下：

```tsx
// 这是一个 VNode (Virtual Node)
const vnode = {
    type: 'div',         // 描述标签名
    props: {             // 描述属性
        class: 'title'
    },
    children: 'hello',   // 描述子节点
    shapeFlag: 1         // (优化用) 描述节点类型
};
```

VNode树是是**组件和HTML 标签交织**在一起的结构。举个例子：

```tsx
<template>
  <div class="app">
    <Header />
    <main>
      <p>Hello</p>
    </main>
  </div>
</template>
```

它生成的 VNode 树结构是这样的：

```tsx
VNode (Type: Component, Name: App)
   └── VNode (Type: HTMLElement, Tag: div)  <-- 真实的 HTML 容器
         ├── VNode (Type: Component, Name: Header) <-- 子组件
         └── VNode (Type: HTMLElement, Tag: main)
               └── VNode (Type: HTMLElement, Tag: p)
                     └── VNode (Type: Text, Content: "Hello")
```

## 渲染 (Render)

渲染器 (Renderer) 是运行时的心脏，它的工作本质就是把 **虚拟 DOM** 翻译成 **真实 DOM，**它的工作流程分为两个阶段：**挂载 (Mount)** 和 **更新 (Patch)**。

![渲染器](https://youke3.picui.cn/s1/2026/01/10/69620d94012c1.png)

- **阶段一：挂载 (Mount)**,当组件第一次在页面上显示时，渲染器执行 **初始化** 逻辑，输入一棵 VNode 树，递归处理这棵树，调用浏览器 API 创建对应的真实 DOM 节点，成功展示在页面中
- **阶段二：更新 (Patch)，**当响应式数据发生变化时，渲染器执行 **更新** 逻辑，**输入**：旧的 VNode 树 (n1) 和 新的 VNode 树 (n2)，执行 **Diff 算法**。即对比新旧两棵树，找出差异（**比如只是文字变了，或者某个属性变了**），然后**仅修改**那些变动的真实 DOM 节点

**重点：组件是更新的调度单位，DOM 元素是更新的执行单位（更新细粒度比较的细-确保了性能）**

Vue 的响应式系统在宏观上将依赖收集的边界锁定在组件层级（Component Level），确保了更新信号只发送给受影响的组件；而渲染器在微观上通过 Diff 算法比对新旧 VNode 树，将 DOM 操作的范围精确收敛到具体的元素节点（HTMLElement Level）

## 架构分层：Runtime-Core 与 Runtime-DOM

为了遵循**单一职责原则**和**跨平台能力，vue将运行时分为了2层：**

- Runtime-Core (**核心运行时**) ，包含了 Vue 运行时的通用逻辑，**不依赖具体的宿主环境，包括像**
VNode 的创建 (`h` 函数)， 组件的生命周期管理， Diff算法
- Runtime-DOM (**浏览器运行时**)，专门针对浏览器环境的适配层，实现 `runtime-core` 需要的接口，真正的DOM操作

然后整个过程其实主要是在实现**Runtime-Core模块**
